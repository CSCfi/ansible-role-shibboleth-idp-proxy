# - name: Apache related configuration
# ==================================
- name: Proxy | Apache | configure | conf.d/idpproxy.conf
  template: src=etc/httpd/conf.d/idpproxy.conf dest=/etc/httpd/conf.d/idpproxy.conf backup=no

- name: Proxy | Apache | configure | index.html
  copy:
    dest: /var/www/html/index.html
    content: |
      <html>
        <head>
          <title>Nothing</title>
        </head>
        <body>
          <p>Nothing here</p>
      </body>
      </html>

- name: Proxy | Apache | Configure | conf.d/shib.conf | /idp block
  blockinfile:
    dest: "/etc/httpd/conf.d/shib.conf"
    marker: "### {mark} ansible managed - idp block ###"
    insertafter: EOF
    block: |
      <Location /idp>
        AuthType shibboleth
        require shibboleth
        ShibUseHeaders On
      </Location>
  notify:
    - restart apache

# - name: Jetty related configuration
# ===================================

- name: Proxy | Jetty | copy | jetty.xml
  copy:
    src: "{{ shibbolethidp_jetty_home }}/etc/jetty.xml"
    dest: "{{ shibbolethidp_jetty_base }}/etc/jetty.xml"
    remote_src: true

- name: Proxy | Jetty | Configure | add Customizer to allow forwarded https
  blockinfile:
    dest: "{{ shibbolethidp_jetty_base }}/etc/jetty.xml"
    marker: "<!-- {mark} ansible managed - customizer to allow forwarded https -->"
    insertafter: '<New id="httpConfig" class="org.eclipse.jetty.server.HttpConfiguration">'
    content: |
      <Call name="addCustomizer">
        <Arg><New class="org.eclipse.jetty.server.ForwardedRequestCustomizer"/></Arg>
      </Call>

# - name: Shibboleth SP related configurations
# ============================================

- name: Proxy | ShibSP | Remove | plugins.so 
  xml:
    path: /etc/shibboleth/shibboleth2.xml
    xpath: /x:SPConfig/x:OutOfProcess/x:Extensions
    state: absent
    namespaces:
      x: urn:mace:shibboleth:3.0:native:sp:config

- name: Proxy | ShibSP | Add | plugins.so 
  xml:
    file: "/etc/shibboleth/shibboleth2.xml"
    xpath: '/x:SPConfig/x:OutOfProcess'
    pretty_print: yes
    namespaces: &namespaces
      x: urn:mace:shibboleth:3.0:native:sp:config
    add_children:
      - Extensions:
          _:
            - Library:
                path: "plugins.so"
                fatal: "false"

- name: Proxy | ShibSP | Remove | AttributeResolver
  xml:
    path: /etc/shibboleth/shibboleth2.xml
    xpath: "/x:SPConfig/x:ApplicationDefaults/x:AttributeResolver[@type='Chaining']"
    state: absent
    namespaces:
      x: urn:mace:shibboleth:3.0:native:sp:config

- name: Proxy | Shibboleth-sp | Configure | AttributeResolver 
  xml:
    file: "/etc/shibboleth/shibboleth2.xml"
    xpath: '/x:SPConfig/x:ApplicationDefaults/x:AttributeExtractor'
    insertafter: true
    pretty_print: yes
    namespaces:
      x: urn:mace:shibboleth:3.0:native:sp:config
    add_children:
      - AttributeResolver:
          type: "Chaining"
          _:
            - AttributeResolver:
                type: "Query"
                subjectMatch: "true"
            - AttributeResolver:
                type: "Template"
                sources: "virtuLocalID virtuHomeOrganization"
                dest: "vppn"
                _:
                  - Template: "$virtuLocalID@$virtuHomeOrganization"
            - AttributeResolver:
                type: "Template"
                sources: "EduuniId"
                dest: "EduuniIdScoped"
                _:
                  - Template: "$EduuniId@eduuni.fi"

  #  blockinfile:
  #    dest: "/etc/shibboleth/shibboleth2.xml"
  #    marker: "        <!-- {mark} ansible managed - AttributeResolver block -->"
  #    insertafter: '<AttributeExtractor type='
  #    content: |2
  #              <AttributeResolver type="Chaining">
  #                <AttributeResolver type="Query" subjectMatch="true"/>
  #                <AttributeResolver type="Template" sources="virtuLocalID virtuHomeOrganization" dest="vppn">
  #                  <Template>$virtuLocalID@$virtuHomeOrganization</Template>
  #                </AttributeResolver>
  #                <AttributeResolver type="Template" sources="EduuniId" dest="EduuniIdScoped">
  #                  <Template>$EduuniId@eduuni.fi</Template>
  #                </AttributeResolver>
  #              </AttributeResolver>
  #  - '//x:bean[@id="shibboleth.PrincipalSerializers"]'

- name: Shibboleth SP | Configure | ApplicationDefaults -> attributePrefix
  xml:
    xpath: "{{ item.xpath }}"
    attribute: "{{ item.attribute }}"
    value: "{{ item.value }}"
    ensure: "{{ item.ensure }}"
    file: /etc/shibboleth/shibboleth2.xml
    namespaces:
      x: urn:mace:shibboleth:3.0:native:sp:config
  with_items:
    - { xpath: "//x:SPConfig/x:ApplicationDefaults", attribute: attributePrefix, value: "SHIBSP-", ensure: present }


# - name: Shibboleth-IdP related configration
# ===========================================

- name: Shibboleth IdP | OIDC | Configure | relaying-party.xml | remove consents and signs
  xml:
    xpath: "{{ shibbolethidp_item }}"
    state: "absent"
    file: /opt/shibboleth-idp/conf/relying-party.xml
    namespaces:
      x: http://www.springframework.org/schema/beans
      p: http://www.springframework.org/schema/p
  with_items:
    - "//x:bean[@parent='SAML2.SSO']/@p:postAuthenticationFlows"
    - "//x:bean[@parent='SAML2.SSO']/@p:signAssertions"
    - "//x:bean[@parent='SAML2.SSO']/@p:signResponses"
    - "//x:bean[@parent='SAML2.SSO']/@p:encryptAssertions"
    - "//x:bean[@parent='OIDC.SSO']/@p:postAuthenticationFlows"
  loop_control:
    loop_var: shibbolethidp_item
  notify: restart shibboleth-idp

- name: Main | Jetty | Configure | settings 
  lineinfile: dest={{ item.dst }} regexp="^#?\s*({{ item.name }}\s*=)" backrefs=yes  line="\\1 {{ item.value }}"
  with_items: 
    - name: jetty.httpConfig.requestHeaderSize
      dst: "{{ shibbolethidp_jetty_base }}/start.d/server.ini"
      value: 32768

#- name: IdP.Service | {{ idp }} | IdP | Localization | Enable
#  blockinfile:
#    dest: "{{ shibbolethidp_idp_home }}/conf/mvc-beans.xml"
#    marker: "<!-- {mark} ansible managed - localeResolver -->"
#    insertbefore: "</beans>"
#    block: |
#      <bean id="localeResolver" class="org.springframework.web.servlet.i18n.CookieLocaleResolver">
#        <property name="cookieName" value="lang"/>
#      </bean>
#  notify:
#    - restart shibboleth-idp
#
- name: Configure | {{ item }} | Del | bean[@id="authn/SAML"] < conf/authn/general-authn.xml
  xml:
    file: "{{ shibbolethidp_idp_home }}/conf/authn/general-authn.xml"
    xpath: /x:beans/x:bean[@id="authn/SAML"]
    namespaces:
      x: "http://www.springframework.org/schema/beans"
      util: "http://www.springframework.org/schema/util"
    state: absent

- name: Configure | {{ item }} | Add | bean[@id="authn/SAML"] > conf/authn/general-authn.xml
  xml:
    file: "{{ shibbolethidp_idp_home }}/conf/authn/general-authn.xml"
    xpath: /x:beans
    pretty_print: yes
    namespaces:
      x: "http://www.springframework.org/schema/beans"
      p: "http://www.springframework.org/schema/p"
      util: "http://www.springframework.org/schema/util"
    add_children:
      - bean:
          id: "authn/SAML"
          parent: "shibboleth.AuthenticationFlow"
          "{http://www.springframework.org/schema/p}nonBrowserSupported": "false"
          "{http://www.springframework.org/schema/p}passiveAuthenticationSupported": "true"
          "{http://www.springframework.org/schema/p}forcedAuthenticationSupported": "true"
          "{http://www.springframework.org/schema/p}proxyScopingEnforced": "true"
          "{http://www.springframework.org/schema/p}discoveryRequired": "false"

- name: Test for line
  shell: grep -c "idp.authn.flows" {{ shibbolethidp_idp_home }}/conf/idp.properties || true
  register: test_grep

- name: add idp.authn.flows host to properties
  lineinfile:
    dest: "{{ shibbolethidp_idp_home }}/conf/idp.properties"
    line: idp.authn.flows=
  when: test_grep.stdout == "0"
